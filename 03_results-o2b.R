

#Results: Output 2b: Data type (including sources and geographic location) of
#   mineral values in the FCTs/FCDBs included for pre-selected foods.

library(tidyverse) # data wrangling
library(gt) # tables generation

#GETTING THE FINAL LIST OF ITEMS ###############

#├ Loading a filtering data for the analysis (item-level)
#Generated by 03_results-o2a.R

filter.data <- read.csv(here::here("inter-output", "filtering-NV-output2b.csv"))

#├ Loading master file with all the FCTs information -----
#├ Loading master file with all the items and references for all the FCTs -----

source("03_results-o2.R")

#├ Loading master file with all references and metadata for all the FCTs -----

readxl::excel_sheets(here::here("data", "food-items-data-collection.xlsx"))

fct.ref <- readxl::read_excel(here::here("data", "food-items-data-collection.xlsx"),
                                      sheet = "fct_ref") %>% 
  mutate_at("fct.ref", str_squish)  

#checking that all FCTs are loaded
#SWU0022 is included - at FCT level (that's is included)
#WA0019 is not included --> Extracted from FCT (section 3)
fct.ref %>% count(fct.id)

#├ Cleaning and fixing minor issues -----

#fixing a typo
fct.ref$fct.id[fct.ref$fct.id == "AF0024"] <- "AF0023"

#adding a citation/ standardising citation 

fct.ref$fct.ref.citation[fct.ref$fct.id == "KT0025" & fct.ref$fct.ref == "Watts"] <-"Watts, MJ, Joy, EJM, Young, SD, Broadley, MR, Chilimba, ADC, Gibson, RS, Siyame, EWP, Kalimbira, AA, Chilima, B, & Ander, EL, 2015, ‘Iodine source apportionment in the Malawian diet’, Scientific Reports, vol. 5, no. 1, p. 15251, doi: 10.1038/srep15251."


fct.ref %>% count(ref.id, sort = T)

fct.ref %>% filter(ref.id == "R7_1996")
fct.ref %>% filter(str_detect(ref.id,"R10_")) %>% gt()

fct.ref$ref.id[fct.ref$ref.id == "R11_1968"] <- "R1_1968"

fct.ref$fct.ref.citation[fct.ref$ref.id == "R1_1968"] <- "Wu Leung W.T, Busson F, Jardin C. Food Composition Table for use in Africa. 1968; Rome: FAO and Bethesda: US Department of Health, Education and Welfare."
fct.ref$fct.ref.citation[fct.ref$ref.id == "R15_2008"] <-"Lukmanji Z, Hertzmark E, Mlingi N, Assey V, Ndossi G, Fawzi W. 2008. Tanzania food composition tables"
fct.ref$fct.ref.citation[fct.ref$ref.id == "R8_2010"] <-"Stadlmayr B, Charrondiere RU, Addy P, Samb B, Enujiugha VN, Bayili RG, Fagbohoun EG, Smith IF, Thiam I, Burlingame B. 2010. Composition of Selected Foods from West Africa"
fct.ref$fct.ref.citation[fct.ref$ref.id == "R14_1978"] <-"Paul AA, Southgate DAT, McCance and Widdowson's The Composition of Foods. 4th ed. 1978; London: HM Stationery Office."

fct.ref$fct.ref.citation[fct.ref$output1_fct.id == "SF022"] <-"Korkalo L, Hauta-alus H, Mutanen M. 2011. Department of Food and Environmental Sciences, University of Helsinki, Finland. Food composition tables for Mozambique.  Version 2"

fct.ref$ref.id[fct.ref$fct.ref.citation == "U.S. Department of Agriculture, Agricultural Research Service. USDA National Nutrient Database for Standard Reference, Releases 21-24. http://www.nal.usda.gov/fnic/foodcomp/search/"] <- "R10_2016"

#Speek et al, 1986 - Samples were bought at a local market in Dar es Salaam, Tanzania
fct.ref$fct.ref.location[fct.ref$ref.id == "R13_1986"] <- "Tanzania"

# Fixing citations ----
fct.ref$fct.ref.citation[fct.ref$fct.ref.citation == "Sayed N, Frans Y, Schönfeldt H. 1999. Composition of South African foods. Milk & milk products, eggs, meat & meat products. Parow: Medical Research Council; 1999."] <-"Sayed N, Frans Y, Schönfeldt H. Composition of South African foods. Milk & milk products, eggs, meat & meat products. Supplement to the MRC Food composition tables 1991. Parow: Medical Research Council; 1999."
fct.ref$fct.ref.citation[fct.ref$fct.ref.citation == "Kruger M, Sayed N, Langenhoven M, Holing F. (1998). Composition of South African foods. Vegetables and fruit.  Tygerberg: Medical Research Council; 1998."] <- "Kruger M, Sayed N, Langenhoven M, Holing F. Composition of South African foods. Vegetables and fruit. Supplement to the MRC food composition tables 1991. Tygerberg: Medical Research Council; 1998."

US_18 <- c("USDA-ARS (U.S. Department of Agriculture, Agricultural Research Service). 2011. USDA National Nutrient Database for Standard Reference. Release 18. Available at http://www.ars.usda.gov/nutrientdata [accessed November 2011]",
           "U.S. Department of Agriculture, Agricultural Research Service. (2005). USDA National Nutrient Database for Standard Reference, Release 18.")

fct.ref$fct.ref.citation[fct.ref$fct.ref.citation %in% US18] <-  "U.S. Department of Agriculture, Agricultural Research Service. 2005. USDA National Nutrient Database for Standard Reference, Release 18. Methods and Application of Food Composition Laboratory Home Page, http://www.ars.usda.gov/nea/bhnrc/mafcl"


i <- which(fct.ref$ref.id == "R13_1986")
fct.ref[i, "fct.ref.location"]



# 1) NV metadata analysis: ----

#├  Level of reporting  -----

#FCT that reported at FCT level
#NOTE: Data origin should be coded as unknown.

fct.fct <- c("ZW0009", "TZ0011") #"SW0022"

#Adding fct.ref as the own FCT for FCTs that reported ref. at FCT level
fct.item$fct.ref[fct.item$fct.id == "ZW0009"] <- "ZW0009"
fct.item$fct.ref[fct.item$fct.id == "TZ0011"] <- "TZ0011"

#Checking FCTs w/ and w/o ref. at fct level
fct.item %>% filter(!fct.ref %in% fct.fct, !is.na(food.name.original), !is.na(fct.ref)) %>% count(fct.id)

item.level <- fct.item %>% filter(!fct.ref %in% fct.fct, 
                                  !is.na(food.name.original),
                                  !is.na(fct.ref)) %>% 
  distinct(fct.id)%>% pull()

item.nv <- fct.item %>% filter(!is.na(food.name.original), is.na(fct.ref)) %>% distinct(fct.id) %>% pull()

fct.item %>% glimpse()

# 2) NV level analysis: ----
#├ General stats

#count of total food items included
fct.item %>% filter(!is.na(food.name.original), is.na(fct.ref)) %>% count()

#Converting into a longer df for analysis

fct.mn <- fct.item %>% filter(fct.id %in% item.nv) %>% 
  dplyr::select(-fct.ref) %>% 
  pivot_longer(.,
               cols = starts_with("fct.ref_"),
               names_to = "mn", 
               values_to = "fct.ref" ) %>% 
  mutate_at("mn", ~str_replace(., "fct.ref_", "")) %>% 
  relocate(comments, .after = fct.ref) 

#checking the variables and that we have the correct FCTs
dim(fct.mn)
fct.mn %>% glimpse()
fct.mn %>% distinct(fct.id)

#Counting items are the same - The 4 items discrepancy is
#due to four items in AF0023 having NA for the mineral values.
fct.mn %>% filter(!is.na(food.name.original), !is.na(fct.ref)) %>% 
  distinct(fct.id, food.id.original, food.name.original) %>% 
  count()

#checking the no. of same source of the values were used. 
fct.mn %>% 
  filter(!is.na(fct.ref)) %>% 
  count(fct.id, mn, fct.ref) %>% arrange(desc(n)) %>% gt()

#MZ0014 has more than one ref. per NV-item --> convert into rows
#removing the item no. from the fct.ref and adding to comments

fct.mn %>% pull(fct.ref) %>% str_extract(., "\\([:graph:]*\\)") 

fct.mn <- fct.mn %>% separate_rows(fct.ref, sep = ",") %>%
  mutate_at("fct.ref", str_squish) %>% 
  mutate(comments = ifelse(str_detect(fct.ref, "\\([:graph:]*\\)"), 
                           paste0(comments, ", item_id = " , 
                                  str_extract(fct.ref, "\\([:graph:]*\\)")), 
                           comments), 
         fct.ref = ifelse(str_detect(fct.ref, "\\([:graph:]*\\)"), 
                            str_extract(fct.ref, "[:digit:]{1}"),
                            fct.ref))
dim(fct.mn)

#Fixing ome issues/typos due to the separation of MZ0014 ref
fct.mn %>% filter(fct.id == "MZ0014") %>% distinct(fct.ref, comments)

fct.mn$fct.ref[fct.mn$fct.ref == "D 4"] <- "D4" 
fct.mn$fct.ref[fct.mn$fct.id == "MZ0014" & fct.mn$fct.ref == "15"] <- "D15" 
fct.mn$fct.ref[fct.mn$fct.id == "MZ0014" & fct.mn$fct.ref == "17"] <- "D17" 

#No. of unique/distinct ref. per FCTs (and per item/nutrient)

#we need to filter out empty food names and make the unique entries per fct, 
#id and name 
#116 ref are NA -> Meaning that those minerals were not reported.
fct.mn %>% filter(!is.na(food.name.original), is.na(fct.ref))

fct.mn %>% filter(!is.na(food.name.original), !is.na(fct.ref)) %>% 
  distinct(fct.id, food.id.original, food.name.original, fct.ref) %>% 
  count(fct.ref, sort = T)

#Merging with the ref. name and type to the ref. ids.

#Checking ref. citation

fct.mn %>% left_join(., fct.ref) %>%
  filter(!is.na(fct.ref), is.na(fct.ref.citation)) %>% count(fct.id)

#EA0006 == Assumed zero
#ML0017 == We do not have information on that data
#MZ0014 == Citation I25 vs F25 --> Fixed above (line 133)
#KT0025 == Analitycal data --> solved

fct.mn %>% left_join(., fct.ref) %>% filter(!is.na(fct.ref), is.na(fct.ref.citation)) %>% 
  filter(fct.id == "WK0025")

fct.mn %>% left_join(., fct.ref) %>% 
  filter(!is.na(fct.ref), is.na(fct.ref.type)) %>% count(fct.id)

#Merging source of information to nV-level reporting

ref.mn <- fct.mn %>% filter(!is.na(food.name.original), !is.na(fct.ref)) %>%
                    left_join(., fct.ref) 

ref.mn %>% filter(ref.id == "R9_2004") %>% distinct(fct.ref.citation) %>% pull()
ref.mn %>% count(ref.id, sort = T)

#Harmonising NA
ref.mn <- ref.mn %>% naniar::replace_with_na(replace =list(ref_type_id = "NA", 
                                                           fct.ref.reporting = "NA")) 

ref.mn %>% filter(is.na(ref_type_id)) %>% count(fct.id)

##├ Summary stats: NV and ref.  ----- 

#No. of items included

ref.mn %>% distinct(food.id.original, food.name.original,
                    fct.id) %>% 
  count(fct.id)

# No. of ref. per NV, ref type and ref id 

ref.mn %>% 
  distinct(fct.id, food.id.original, 
           food.name.original, mn, fct.ref.type, ref_type_id, ref.id) %>% 
    count(mn, fct.ref.type,ref_type_id, ref.id, sort = T) 

#R8_2010 - se & i
#R15_2008 = ca, fe & zn

# No. of ref. per NV, ref type and ref id (WEIGTHED) - double-check

ref.mn %>% left_join(., ref.mn %>% 
                       distinct(fct.id, food.id.original, 
                                food.name.original) %>%
                       group_by(fct.id) %>% 
                       summarise(weight = 1/n()))  %>% 
  distinct(fct.id, food.id.original, 
           food.name.original, mn,  ref.id, weight) %>% 
  group_by(mn,  ref.id, weight) %>% 
  summarise(n = sum(weight)) %>% arrange(desc(n))

ref.mn %>% 
  distinct(fct.id, food.id.original, 
           food.name.original, mn,  ref.id) %>% 
  group_by(mn,  ref.id) %>% 
  summarise(n = n()) %>% arrange(desc(n))

#R14_2015 - i
#R8_2012 - fe, zn 
#R9_2004 - ca
#R8_2010 - se



# No. of ref. per NV, ref type and ref location

ref.mn %>% 
  distinct(fct.id, food.id.original, 
           food.name.original, mn, fct.ref.type, ref_type_id, fct.ref.location) %>% 
  count(mn, fct.ref.type, ref_type_id, fct.ref.location , sort = T)  %>% gt()

# No. of ref. per NV, ref type and ref location (WEIGTHED) - double-check

ref.mn %>% left_join(., ref.mn %>% 
 distinct(fct.id, food.id.original, 
           food.name.original) %>%
  group_by(fct.id) %>% 
 summarise(weight = 1/n()))  %>% 
  distinct(fct.id, food.id.original, 
           food.name.original, mn, fct.ref.type, ref_type_id, fct.ref.location, weight) %>% 
  group_by(mn, fct.ref.type, ref_type_id, fct.ref.location, weight) %>% 
  summarise(n = sum(weight)) %>% arrange(desc(n))


##├  Plot: No. of ref. per NV and ref type  -----

ref.mn %>% filter(!is.na(fct.ref), !is.na(ref_type_id)) %>% 
  group_by(mn, ref_type_id) %>% 
  summarise(n = n()) %>% 
  mutate_at("mn", ~str_replace_all(., c("ca" = "Ca",
                                    "fe" = "Fe",
                                    "io" = "I", 
                                    "se" = "Se", 
                                    "zn" = "Zn"))) %>% 
 ggplot(aes(reorder(ref_type_id, n), n, fill = ref_type_id)) + 
  geom_bar(stat = "identity") +
  coord_flip() +
  facet_grid(vars(mn), scales = "free_y") +
  scale_fill_manual("Source of mineral values",
                    values =c("darkolivegreen3","lightgoldenrod2", "red4", "red", "lightgrey"), 
                    labels = c("Analysed for the FCT (av1)",
                               "Analysed from publications (av2)",
                               "Imputed from African FCT (iv1)", 
                               "Imputed from outside African FCT (iv2)", 
                                "Other sources (NA)")) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(), 
    axis.text.y = element_blank(), 
    strip.text.y = element_text(angle = 0, size = 20),
    strip.background = element_rect(colour = "black", fill = "white"), 
    legend.key.size = unit(1.5, 'cm'), 
    legend.title = element_text(size=25),
    legend.text = element_text(size=20)) +
  labs(x="", y = "")
     #  title = "Source of information of the mineral values used in SSA FCTs/FCDBs", 
      #subtitle = "Plot of the count of reported values by mineral and type of source")


#Perfect for ppt (width = 12, height = 7)
#ggsave(here::here("plots", "source-of-info.png"), width = 15, height = 7)


# Plot: No. of ref. per NV, ref type and ref id (WEIGTHED) - double-check
ref.mn %>% left_join(., ref.mn %>% 
                       distinct(fct.id, food.id.original, 
                                food.name.original) %>%
                       group_by(fct.id) %>% 
                       summarise(weight = 1/n()))  %>% 
  distinct(fct.id, food.id.original, 
           food.name.original, mn, fct.ref.type, ref_type_id,
           fct.ref.location, weight) %>% 
  group_by(mn, fct.ref.type, ref_type_id, fct.ref.location, weight) %>% 
  summarise(n = sum(weight))  %>% 
  ggplot(aes(ref_type_id, n)) + geom_bar(stat = "identity") 


# Food Composition used (iv1)

ref.mn %>% filter(ref_type_id == "iv1") %>% 
  distinct(ref.id,fct.ref.citation, fct.ref.location) %>% 
  arrange(fct.ref.location) %>% gt()

ref.mn %>% filter(ref_type_id == "iv1") %>% 
  distinct(fct.id, food.id.original, 
           food.name.original, ref.id,fct.ref.citation, fct.ref.location) %>% 
  count(ref.id,fct.ref.citation, fct.ref.location)  %>% 
  arrange(desc(n))  %>% 
  arrange(fct.ref.location)

ref.mn %>% filter(ref.id == "R48_2011")

# Food Composition used (iv2)

ref.mn %>% filter(ref_type_id == "iv2") %>% 
  distinct(ref.id,fct.ref.citation, fct.ref.location) %>% 
  arrange(fct.ref.location) %>% gt()

ref.mn %>% filter(ref_type_id == "iv2") %>% 
  distinct(fct.id, food.id.original, 
           food.name.original, ref.id,fct.ref.citation, fct.ref.location) %>% 
  count(ref.id,fct.ref.citation, fct.ref.location)  %>% 
  arrange(desc(n))  %>% 
  arrange(fct.ref.location)

# Analytical values (av1)

ref.mn %>% filter(ref_type_id == "av1") %>% 
  distinct(fct.id, fct.ref.location) 

# Analytical values from publications (av2)

ref.mn %>% filter(ref_type_id == "av2") %>%
  distinct(fct.id, food.id.original, 
           food.name.original) %>% 
  count(fct.id)  %>% 
  arrange(desc(n))  
  
ref.mn %>% filter(ref_type_id == "av2") %>% 
  distinct(ref.id,fct.ref.citation, fct.ref.location) %>% 
  arrange(fct.ref.location) %>% gt()

ref.mn %>% filter(ref_type_id == "av2") %>%
  distinct(fct.id, food.id.original, 
           food.name.original, ref.id,fct.ref.citation, fct.ref.location) %>% 
  count(ref.id,fct.ref.citation, fct.ref.location)  %>% 
  arrange(desc(n))  %>% 
  arrange(fct.ref.location)

ref.mn %>% filter(fct.ref.location == "Gambia") %>% distinct(ref.id)
ref.mn %>% filter(ref.id %in% c("R6_1993", "R7_1996")) %>% distinct(fct.id)
ref.mn %>% filter(ref.id %in% c("R6_1993", "R7_1996")) %>% distinct(food.category, mn)
ref.mn %>% filter(ref.id == "R16_2015") %>% distinct(food.category, mn)


#Total values reported at nutrient level and
# Total values that could be traced back to their origin:

fct.mn %>% filter(!is.na(food.name.original), !is.na(fct.ref)) %>% count()

ref.mn %>% filter(ref_type_id %in% c("av1", "av2") | str_detect(ref.id,"R10_|R14")) %>% count()

#all imputed values from other foods, calculated, assumed zero or "updated"/"replaced"
ref.mn %>% filter(is.na(ref_type_id)) %>% gt()

mn <- tolower(c("Ca" , "Fe",  "Se", "Zn", "I"))

ref.mn %>% filter(mn == mn[i]) %>% 
   filter(!is.na(food.name.original), !is.na(fct.ref)) %>% 
  count(fct.id, ref_type_id, fct.ref.location, fct.ref.citation)  %>% 
  arrange(desc(n))  %>% 
  #arrange(fct.id) %>%
  gt()  %>%
  tab_header(
    title = "Count of Calcium values reported in different FCTs per source of nutrient reported",
    subtitle = ""
  )

ref.mn %>% 
 # distinct(fct.id, food.id.original, 
  #         food.name.original, mn, ref_type_id, fct.ref.location) %>% 
  count(mn, ref_type_id, fct.ref.location)  %>% 
  arrange(desc(n))  %>% 
  arrange(mn) %>% gt()  %>%
  tab_style(
    locations = cells_column_labels(columns = everything()),
    style     = list(
      cell_borders(sides = "bottom", weight = px(3)),
      cell_text(weight = "bold")))
    
    
##├  Plot: NV by location  -----

data_long <- ref.mn %>% select(fct.id, mn, fct.ref.location) %>% 
  left_join(., output1 %>% select(fct.id, country, continent.region)) %>% 
  mutate(ref_fct = ifelse(country == "NA", 
                          continent.region, 
                          country)) %>% 
  select(-c("fct.id", "country", "continent.region")) %>% 
  rename(source = "ref_fct",
         target = "fct.ref.location") %>% 
  relocate(source, .before = "mn")


# 3) Item level analysis: ---- 

# Item level only reporting one ref. per item:

fct.item %>% 
  filter(fct.id %in% c("MW0020", "LS0010", "ZM0012", "CEU0015"), 
         fct.ref != "NA") %>%  
  mutate_at("fct.ref",
      ~str_replace_all(., "USDA-21 \\([:digit:]+\\)", "USDA-21")) %>% 
   left_join(., fct.ref) %>% 
  count(ref_type_id, fct.ref.location)  %>% 
  arrange(desc(n))

names(output1)
ref.item1 <- fct.item %>% 
  filter(fct.id %in% c("MW0020", "LS0010", "ZM0012", "CEU0015"), 
         fct.ref != "NA") %>%  
  mutate_at("fct.ref",
            ~str_replace_all(., "USDA-21 \\([:digit:]+\\)", "USDA-21")) %>% 
  left_join(., fct.ref) %>% 
  left_join(., output1 %>%
              dplyr::select(fct.id, country, continent.region, MNreported)) %>% 
  rename(mn = "MNreported") %>% dplyr::select(colnames(ref.mn)) %>% 
  separate_rows(mn, sep = ",") %>% 
  mutate_at("mn", str_squish) 

dim(ref.item1)

fct.item %>% filter(fct.id == "LS0010") %>% 
  distinct(food.id.original) %>% 
  pull(food.id.original) %>% sort()


#filtering out entries w/o NV reported

#Checking the no. of items per fct, to see that we are
#getting all data 
#MW0020 - "loosing" one item (MW08_0006 - sugar) - because all NVs
#were NA

filter.data %>% 
  filter(fct.id %in% c("MW0020", "LS0010", 
                       "ZM0012", "CEU0015")) %>% 
  distinct(food.id.original, fct.id) %>% count(fct.id)

ref.item1 %>% filter(fct.id == "MW0020") %>% 
            distinct(food.id.original) %>% 
  pull(food.id.original) %>% sort()

ref.item1$food.id.original <- str_replace(ref.item1$food.id.original, "^0", "")

ref.item1  %>% 
  inner_join(., filter.data) %>% 
  distinct(food.id.original, fct.id) %>% count(fct.id)


ref.item1 <- ref.item1  %>% 
  inner_join(., filter.data) 

#No. of items included
ref.item1 %>% distinct(food.id.original) %>% count()

ref.mn1 <- rbind(ref.mn, ref.item1)

ref.mn1 %>% filter(!fct.id %in% c("MW0020", "LS0010", 
                                 "ZM0012", "CEU0015")) %>%
  distinct(food.name.original, food.id.original, fct.id) %>% count()

#No. of items included
ref.mn1 %>% 
  distinct(food.id.original,
                     food.name.original, fct.id) %>% 
  count(fct.id) %>% mutate(
    perc = n/286*100) %>% arrange(desc(perc))

ref.mn1$ref_type_id[ref.mn1$ref_type_id == "NA"] <- NA

##├  Plot: Perc./ No. of ref. per NV and ref type  -----

#For percentage var2 = perc 
#For count (no.) var2 = y 

ref.mn1 %>% 
  #  filter(fct.id != "AF0023") %>% 
  group_by(mn) %>% 
  summarise(n = n(),
            ref_type_id) %>% 
  group_by(mn, ref_type_id, n) %>% 
  summarise(n,
            y = n(),
            perc = n()/n*100) %>% distinct() %>% 
mutate_at("mn", ~str_replace_all(., c("ca" = "Ca",
                                      "fe" = "Fe",
                                      "io" = "I", 
                                      "se" = "Se", 
                                      "zn" = "Zn"))) %>% 
     create_barplot(., ref_type_id, y, mn) #here to change the variable!


#Perfect for ppt (width = 12, height = 7)
ggsave(here::here("plots", "source-of-info.png"), width = 15, height = 7)

# Plot: No. of ref. per NV, ref type and ref id ("normalised") - double-check
ref.mn1 %>% left_join(., ref.mn1 %>% 
                       distinct(fct.id, food.id.original, 
                                food.name.original) %>%
                       group_by(fct.id) %>% 
                       summarise(weight = 1/n()))  %>% 
  distinct(fct.id, food.id.original, 
           food.name.original, mn,  ref_type_id, weight) %>% 
  group_by(mn,  ref_type_id, weight, fct.id) %>% 
  summarise(n_normal = sum(weight),
            n_count = n()) %>% arrange(desc(n_count)) %>% 
  mutate_at("mn", ~str_replace_all(., c("ca" = "Ca",
                                        "fe" = "Fe",
                                        "io" = "I", 
                                        "se" = "Se", 
                                        "zn" = "Zn"))) %>% 
  create_barplot(., ref_type_id, n_normal, mn)




##├ Table (TO-DO): Frequency: FCT, NV, Ref. type  -----

ref.mn1 %>%  group_by(fct.id, mn, ref_type_id) %>%
  count () %>%
  pivot_wider(
    names_from = mn,
    values_from = n) %>% arrange(desc(fct.id)) %>% 
   knitr::kable()



###

#Checking locations by type of data (av1, av2, iv1, iv2)
#MW0020, i.e., Ferguson, et al., 1989 (Fe, Se)  - ref = 9 -
#MW0020, i.e., Hwang, et al., 2016 (Fe, Ca, Zn ) - ref = 7 - did not report Minerals (reported in blue font)
#MW0020, i.e., Chilungo, et al., 2013 (Fe, Ca, )  - ref = 8 - did not report Minerals
#MW0020, i.e., Chingala, et al., 2018 (Fe, Ca, )  - ref = 22 - did not report Minerals
#MW0020, i.e., Mlotha, et al., 2014 (Fe, Ca, ) - ref = 4 - did not report Minerals
#MW0020, i.e., Neba, et al., 2015 (Fe, Ca, )  - ref = 20 - only Minerals Na and K
#MW0020, i.e., Pambuwa, et al., 2017 (Fe, Ca, ) - ref = 26 - did not report Minerals

#EA0006 - Speek et al, 1986  - ref = 19 - did not reported minerals

#├ Summary: No. of min. values from each type of values ----

ref.mn1 %>%
  distinct(fct.id, food.id.original, food.name.original, mn, ref_type_id) %>%
  count(ref_type_id) 

#IV2: 
ref.mn1 %>% filter(ref_type_id == "av2"
                   # fct.id != "AF0023", 
                   # mn == "ca"
)  %>% count(fct.id, fct.ref.citation, fct.ref.location,
             data_collection_location, mn) %>%
  arrange(desc(n)) %>% 
  View()

# No. of "secondary analytical" values per FCT
ref.mn1 %>% filter(ref_type_id == "av2") %>%
  count(fct.id)
# No. of "secondary analytical" values
ref.mn1 %>% filter(ref_type_id == "av2") %>%
  count()
# No. of "primary analytical" values per FCT
ref.mn1 %>% filter(ref_type_id == "av1") %>%
  count(fct.id)
# No. of "primary analytical" values
ref.mn1 %>% filter(ref_type_id == "av1") %>%
  count()

# Locations of the secondary analytical values
ref.mn1 %>% filter(ref_type_id == "av2"
)  %>% count( fct.ref.citation, fct.ref.location,
              data_collection_location) %>%
  arrange(desc(n))

# Locations of the secondary analytical values
ref.mn1 %>% filter(ref_type_id == "av2"
)  %>% count( fct.ref.location) %>%
  arrange(desc(n))

# Malawi studies used as secondary analytical values
ref.mn1 %>% filter(ref_type_id == "av2", 
                   fct.ref.location == "Malawi"
)  %>% count( fct.ref.citation, fct.ref.location,
              data_collection_location) %>%
  arrange(desc(n))



ref.mn1 %>% left_join(., output1 %>% select(fct.id, fct.name)) %>%
  group_by(fct.name, ref_type_id, fct.ref.location) %>% 
  summarise(
            num.val = length(ref_type_id))

ref.mn1 %>% filter(ref_type_id == "iv1") %>% 
  distinct(fct.ref.citation, fct.ref.location, output1_fct.id)

ref.mn1 %>% filter(ref_type_id == "av2"
                  # fct.id != "AF0023", 
                  # mn == "ca"
                   ) %>% 
  count(fct.ref.location) %>%
  arrange(desc(n)) 

ref.mn1 %>% filter(str_detect(fct.ref.citation, "^Stadlmayr"))

ref.mn1 %>% filter(ref_type_id == "iv1",
                   fct.ref.location %in% c("Gambia", "Mozambique")) %>% 
  select(fct.id,food.id.original, food.name.original, fct.ref.location, comments )

#Beans, sugar, dried, raw --> could trace back the values to the original food item
#Freshwater fish --> =3581*(100-62)/(100-42.3) E(193, 141)

ref.mn1 %>% filter(food.name.original == "Freshwater Fish", 
                   fct.ref == "i")

ref.mn1 <- ref.mn1 %>% 
  mutate(ref.location = ifelse(ref_type_id == "iv1",
    case_when(
       food.name.original == "Freshwater Fish" & fct.ref == "i" ~ "Mozambique",
        TRUE ~ "Unknown"), fct.ref.location )) 


data_long <- ref.mn1 %>% filter(ref_type_id == "iv1") %>%
  left_join(., output1 %>% select(fct.id, fct.name)) %>% 
  select(fct.name, 
         fct.ref.location,          ref.location) %>% 
  rename(source = "fct.name",
         target = "fct.ref.location")

data_long$target <- paste(data_long$target, " ", sep="")

hchart(data_to_sankey(data_long), "sankey",
       name = "Food composition data from SSA: Actual Geographic location") %>% 
#  hc_title(text= "Sankey Diagram") %>%
 # hc_subtitle(text= "Food composition data from SSA: Actual Geographic location") %>%
  hc_plotOptions(series = list(dataLabels = list( style = list(fontSize = "15px"))))

# Data on the Geographic origin of the data ------------

#Checking locations for unknown locations
#MW0020, i.e., Ferguson, et al., 1989 (Fe, Se)  - ref = 9 - Ca was reported as "Tr" hence reported from a differen source, while Zn was used. 
#MW0020, i.e., Hwang, et al., 2016 (Fe, Ca, Zn ) - ref = 7 - did not report Minerals (reported in blue font)
#MW0020, i.e., Chilungo, et al., 2013 (Fe, Ca, )  - ref = 8 - did not report Minerals
#MW0020, i.e., Chingala, et al., 2018 (Fe, Ca, Zn )  - ref = 22 - did not report Minerals
#MW0020, i.e., Mlotha, et al., 2014 (Fe, Ca, ) - ref = 4 - did not report Minerals
#MW0020, i.e., Neba, et al., 2015 (Fe, Ca, Zn )  - ref = 20 - only Minerals Na and K
#MW0020, i.e., Pambuwa, et al., 2017 (Fe, Ca, ) - ref = 26 - did not report Minerals

subset(ref.mn1, fct.id == "MW0020" &
         fct.ref %in% c("9", "7", "8", "22", "4", "20", "26")) %>% distinct(food.id.original)

#MW01_0058 - only Zn was used from the ref. 9
#MW02_0004 - Ca and Zn was used from the ref. 9, Se was reported to be used from that ref. which is not.
#MW03_0006 - reported Ca, Fe and Zn from the ref, but we were unable to locate the in the ref. provided.

ref.mn1$ref.location[ref.mn1$fct.id == "MW0020" & ref.mn1$fct.ref %in% c("9", "7", "8", "22", "4", "20", "26")]

ref.mn1$mn[ref.mn1$food.id.original == "MW02_0004"]
ref.mn1$fct.ref[ref.mn1$food.id.original == "MW02_0004"]

#Re-coding ref.location to "UNKNOWN" to account for those that we couldn't allocate to the 
#original source (most of which were coded w/ blue font in MW0020, except MW03_0006, Se in MW02_0004)

#MW0020
ref.mn1$ref.location[ref.mn1$fct.id == "MW0020" & ref.mn1$fct.ref %in% c("7", "8", "22", "4", "20", "26")] <- "Unknown"
ref.mn1$ref.location[ref.mn1$food.id.original == "MW01_0058" & ref.mn1$mn %in% c("ca", "fe")] <- "Unknown"
ref.mn1$ref.location[ref.mn1$food.id.original == "MW02_0004" & ref.mn1$mn %in% c("se", "fe")] <- "Unknown"
#EA0006 - Speek et al, 1986  - ref = 19 - did not reported minerals
ref.mn1$ref.location[ref.mn1$fct.id == "EA0006" & ref.mn1$fct.ref == "19"] <- "Unknown"
ref.mn1$ref.location[is.na(ref.mn1$ref.location)] <- "Unknown"
ref.mn1$ref.location[ref.mn1$ref.location == "NA"] <- "Unknown"

ref.mn1  %>%
  count(ref.location, mn) %>%
  arrange(desc(n)) %>% gt()


#Total =  1631 + 33 (ML0017) = 1664 mn reviewed.
subset(filter.data,  fct.id == "ML0017")
subset(fct.mn,  fct.id == "ML0017" & !is.na(fct.ref))
nrow(filter.data) +33

#References with known geographic location
ref.mn1  %>% filter(ref.location != "Unknown") %>% 
  count()

#References with known geographic location (%)
ref.mn1  %>% filter(ref.location != "Unknown") %>% 
  count()/nrow(ref.mn1)

#To account only once for food items - mn w. multiple ref. per value
ref.mn1  %>%  distinct(fct.id, food.id.original, food.name.original, mn) %>% 
  count()

ref.mn1  %>%   filter(ref.location != "Unknown")  %>%
  distinct(fct.id, food.id.original, food.name.original, mn) %>% 
  count()

ref.mn1  %>%   filter(ref.location == "US")  %>%
  distinct(fct.id, food.id.original, food.name.original, mn) %>% 
  count()

ref.mn1  %>%   filter(ref.location == "US")  %>%
  distinct(fct.id, food.id.original, food.name.original, mn) %>%
  count(mn) %>%
  arrange(desc(n)) %>% gt()

ref.mn1  %>%  
  distinct(fct.id, food.id.original, food.name.original, mn, ref.location) %>%
  count(ref.location) %>%
  arrange(desc(n)) %>% gt()


#655 - Unknown
#324 - Known
#979 - total

# WA0019 ==============

source(here::here("01_protocol", "01_pilot-output2.R"))

wa.ref_location <- wa.ref_location %>% rename(fct.ref = "biblio") %>% 
  mutate_at("ref.location", ~str_replace(., "West-Africa", "Western Africa")) %>% 
  mutate_at("ref.location", ~str_replace(., "East-Africa", "Eastern Africa"))

wa0019 <-  fct.item %>% filter(fct.id == "WA0001") %>% 
  tidytext::unnest_tokens(BiblioID, fct.ref) %>%  
  left_join(., biblio) %>% 
  mutate(Reference = ifelse(str_detect(BiblioID, "^[:digit:]{2}\\_"), 
                            "West Africa, 2012", Reference)) %>% 
  filter(!is.na(Reference)) %>% 
  dplyr::select(-c(starts_with("fct.ref_"))) %>% 
  rename(fct.ref = "BiblioID", 
         fct.ref.citation = "Reference") 

wa0019 %>% 
  left_join(., wa.ref_location) %>% 
  filter(is.na(ref.location)) %>% 
  count(fct.ref) %>% arrange(desc(n))


 wa0019 %>% 
  left_join(., wa.ref_location, by = c("fct.ref" = "biblio")) %>% 
  mutate(ref.location = ifelse(str_detect(fct.ref, "^[:digit:]{2}\\_"), 
                               "Western Africa", ref.location)) %>%
   filter(is.na(ref.location)) 
 
 
 ref.location <- c("Western Africa",
    "Nigeria?", 
   "Nigeria", #(Nsukka, Enugu state)
   "Nigeria" , #(south-west)"
   "South Africa, Malawi",
   "Nigeria?",
   "Nigeria",
   "Nigeria?", 
   "Nigeria", #(Samaru community, Zaria)",
   "Nigeria",
   "Benin" , #ph135 
   "Global?",
   "Ghana", #gh1062
   "Nigeria", # (Iwaro-Oka Akoko, Ondo State)", 
   "Nigeria",
   "Bangladesh")
 
#ph135 - provided some info on the differences agro-ecological zones
#gh1062 - provided info on the region where the cultivars were collected
 
wa.ref_location <-  wa0019 %>% 
   left_join(., wa.ref_location) %>% 
   mutate(ref.location = ifelse(str_detect(fct.ref, "^[:digit:]{2}\\_"), 
                                "Western Africa", ref.location)) %>%
   filter(is.na(ref.location)) %>% .["fct.ref"] %>% 
   cbind(., ref.location) %>%
   rbind(.,  wa.ref_location)
  
ref_wa0019 <-  wa0019 %>% 
  left_join(., wa.ref_location) %>% 
  mutate(ref.location = ifelse(str_detect(fct.ref, "^[:digit:]{2}\\_"), 
                               "Western Africa", ref.location))

ref_wa0019 %>% count(ref.location, fct.ref) %>% arrange(desc(n)) %>% 
  arrange(ref.location)

ref_wa0019 <- ref_wa0019 %>% distinct(fct.id, fct.ref,
                                      fct.ref.citation, ref.location)

fct.ref %>% filter(fct.id != "WA0019") %>% 
  rename(ref.location = "fct.ref.location") %>% 
  merge(.,ref_wa0019)

ref_location <- ref_wa0019 %>% rbind(., fct.ref %>% filter(fct.id != "WA0019") %>% 
                       select("fct.id", "fct.ref", "fct.ref.citation", 
                              "fct.ref.location") %>% 
                       rename(ref.location = "fct.ref.location")) %>% 
  mutate_at("ref.location", ~str_replace(., "\\?","")) %>% 
  separate_rows(ref.location, sep = ",") %>% 
  mutate_at("ref.location", str_squish)


ref_location %>% distinct(ref.location) %>% arrange(ref.location) 


ref_location$ref.location[ref_location$ref.location == "Afica"] <-  "Africa"
ref_location$ref.location[ref_location$ref.location == "East Africa"] <- "Eastern Africa"
ref_location$ref.location[ref_location$ref.location == "TZ"] <-"Tanzania"
ref_location$ref.location[ref_location$ref.location == "KN"] <-  "Kenya"
ref_location$ref.location[ref_location$ref.location == "West Africa"] <-  "Western Africa"
ref_location$ref.location[ref_location$ref.location == "World"] <-  "Global"





